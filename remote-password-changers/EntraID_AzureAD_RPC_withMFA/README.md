# Custom Azure AD / Entra ID Password Changer

The provided script leverages the Microsoft Graph functionality in Azure AD / Entra ID. The script is designed to take input in the form of the following components:

- Tenant ID
- Client ID (which originates from an App Registration in Azure AD / Entra ID)
- Client Secret (which again originates from an App Registration in Azure AD / Entra ID)
- username of the managed user in the form of the UPN
- password of the managed user
- new password of the managed user generated by Secret Server

The script is designed to perform the password change as the application itself to facilitate the management of MFA protected accounts.
The heartbeat functionality is designed in such a way it will function for both MFA and non-MFA protected accounts by using error handling logic.

The authentication flow being utilized is based on the resource owner password credentials grant flow. This flow is not recommended for regular use, but is being used in this case due to the fact that the script is designed to run as a service account and the user account being interacted with are managed by Secret Server. For password changing and validation the actual credentials of the account are required without interaction of a human being. This makes that the script can manage accounts that are also protected with MFA.

## Requirements

- Valid Azure AD subscription with Azure AD / Entra ID
- Dedicated App Registration to be used by the password changer.
    - See [this](https://docs.microsoft.com/en-us/graph/auth-register-app-v2) for more information on how to create an App Registration.
    - Detailed steps details provided [below](#creating-an-app-registration).
- Custom template to store application registration information in Delinea Secret Server
    - Detailed steps provided [below](#creating-secret-template-for-application-registration).
- Installation of the [Microsoft Graph PowerShell SDK](https://docs.microsoft.com/en-us/graph/powershell/installation) on the Delinea Distributed Engine
- Template to store AzureAD / EntraID secrets.
    - The username should be stored in the UPN format (username@domain) for the script to function.

## Creating secret template for application registration

The following steps are required to create the secret template for the application registration:
- Log in to the Delinea Secret Server
- Navigate to Admin / Secret Templates
- Click on Create / Import Template
- Click on New, provide a name for the template (for example Entra ID Application Identity) and click on Save
- Click on Fields to add the required fields to the template
- Click on Add Field and create the following fields (optionally enter a description for each field):
    - Tenant ID:
        - Name: TenantID
        - Field Slug Name: tenantid
        - Data Type: Text
        - Click on Save
    - Application ID:
        - Name: ApplicationID
        - Field Slug Name: applicationid
        - Data Type: Text
        - Click on Save
    - Client Secret:
        - Name: ClientSecret
        - Field Slug Name: clientsecret
        - Data Type: Password
        - Click on Save
- This completes the creation of the secret template

## Creating an App Registration

The application registration is used to provide the password changer with the necessary permissions to perform the password change. The following steps are required to create the application registration:
- Log in to the Azure / Entra ID Portal
- Navigate to Azure Active Directory
- Navigate to App Registrations
- Click on New Registration
- Provide a name for the application registration
- Select the appropriate account type (single tenant or multi-tenant)
- Optionally provide a redirect URI
- Click on Register
- Navigate to Certificates & Secrets
- Click on New Client Secret
- Provide a description for the client secret
- Select an expiration date
- Click on Add
- Copy the client secret value and store it in Secret Server using the template created in the previous step
- Navigate to API Permissions
- Click on Add a permission
- Select Microsoft Graph
- Select Delegated permissions
- Select the following permissions:
    - Directory.AccessAsUser.All (required to interact with Graph API on behalf of the user)
    - User.Read
- For the Directory.AccessAsUser.All permission, click on the Grant admin consent for the respective tenant button
- This completes the creation of the application registration

## Providing password changer application with permissions to manage users
- Log in to the Azure / Entra ID Portal
- Navigate to Azure Active Directory / Entra ID
- Navigate to Roles and administrators
- Click on Add a role assignment
- Select the appropriate role (e.g. Global Administrator)
  - Note: The role selected must have the ability to manage users
  - The Password Administrator role is likely insufficient due to the fact that it does not have the ability to change passwords on Administrative Users.
  - To change the password of a global administrator, the global administrator role must be selected.
- Search for and select the application registration created in the previous step
- Click on Add
- This completes the permission assignment of the application registration

## Create secret in Secret Server for the application registration
- Log in to the Delinea Secret Server
- Navigate to Secrets
- Click on Create Secret
- Select the template created in the earlier step (in the example Entra ID Application Identity)
- Fill out the required fields with the information from the application registration
    - Secret Name (for example Delinea Password Changer)
    - Tenant ID (which can be retrieved from the Azure AD / Entra ID properties)
    - Application ID (which can be retrieved from the Application Registration - Allication (client) ID)
    - Client Secret which was generated in the [earlier step](#creating-an-app-registration)
    - Click on Create Secret

## Installation of the Microsoft Graph PowerShell SDK on Distributed Engine
- Log in to the Delinea Distributed Engine
- Open a PowerShell prompt
- Run the following command to install the Microsoft Graph PowerShell SDK:
```powershell
install-module -name Microsoft.Graph -scope allusers
```
- This completes the installation of the Microsoft Graph PowerShell SDK

## Addition of the Azure AD / Entra ID Remote Password Changer Script in Secret Server
- Log in to the Delinea Secret Server
- Navigate to Admin / Scripts
- Click on Create Script
    - Name: Provide a name for the script (for example Azure AD / Entra ID Remote Password Changer)
    - Description: Provide a description for the script (for example Azure AD / Entra ID Remote Password Changer)
    - Select Active
    - Script Type: PowerShell
    - Category: Untyped (selecting hearthbeat or password changer will not work as the script is capable of performing both tasks)
    - Script: Copy the contents of the AzureAD_GraphAPI.ps1 script into the script field
    - Click on Save

## Creation of the Azure AD / Entra ID Remote Password Changer
- Log in to the Delinea Secret Server
- Navigate to Admin / Remote Password Changing
- Click on: Options
    - Click on Configure Password Changers
- Click on Create Password Changer
    - Base Password Changer: Powershell Script
    - Name: Provide a name for the password changer (for example Azure AD / Entra ID Remote Password Changer)
    - Click on Save
- You will be redirected to the password changer configuration page
    - In the Verify Password changed Commands section, provide the following:
        - PowerShell Script: Select the script you created in the previous step
        - Script Args: 
        ```powershell
        hb $[1]$TenantID $[1]$applicationid $[1]$ClientSecret $username $password
        ```	
    - In the Password Change Commands section provide the following:
        - PowerShell Script: Select the script you created in the previous step
        - Script Args: 
        ```powershell
        rpc $[1]$TenantID $[1]$applicationid $[1]$ClientSecret $username $password $newpassword
        ```
    - Click on Save

## Associate the Azure AD / Entra ID Remote Password Changer Secret with the AzureAD template
- Log in to the Delinea Secret Server
- Navigate to Admin / Secret Templates
- Click on the Azure AD Account template
- Click on Mapping
- Click on Edit
- Change the following field to use the password changer you created in the previous step:
    - Password Type to use: Select the password changer you created in the previous step
- Click on Save

## Associate scripting account to Azure AD secret
To be able to correctly use the password changer, the scripting account must be associated with the Azure AD secret. This can be done by following the steps below:
- Log in to the Delinea Secret Server
- Navigate to Secrets
- Locate your secret(s) based on the Azure AD Account template
- Click on the secret
- Click on Remote Password Changing
- Go the Associated Secrets section in the bottom of the page
- Click on Edit
- Click on Add Secret
- Search for the earlier created [secret](#create-secret-in-secret-server-for-the-application-registration) for the application registration and select that
- Click on Save

## Testing the configuration
If all went well, you now should have:
- A secret template for the application registration
- An application registration in Azure AD / Entra ID
- A secret in Secret Server for the application registration
- The password changer script in Secret Server
- The password changer configured in Secret Server to use the script
- The password changer associated with the Azure AD Account template
- An Azure AD Account secret (not covered in this guide)
- The application registration secret associated with the Azure AD Account secret

To test the configuration, you can first start with performing a Heartbeat on the Azure AD Account secret. This can be done by following the steps below:
- Log in to the Delinea Secret Server
- Navigate to Secrets
- Locate your secret(s) based on the Azure AD Account template
- Click on the secret
- Click on Heartbeat
After a few moments the heartbeat should complete successfully.

To test the configuration, you can now change the password of the Azure AD Account secret. This can be done by following the steps below:
- Log in to the Delinea Secret Server
- Navigate to Secrets
- Locate your secret(s) based on the Azure AD Account template
- Click on the secret
- Click on Change Password Now
- Select Randoly Generated or Manual (and enter a password)
- Click on Change Password

If there are any issues, please check the following:
- Heartbeat or Remote Password changing logs in the Web UI of Secret Server
- SSDE.log on the Distributed Engine